<app-navbar></app-navbar>

<div class="form-container">
  <div class="user-form">

  <!-- Selección del método de entrega -->
    <h2>Método de Entrega</h2>

    <div class="delivery-method">
      <label class="delivery-option">
        <input type="radio" name="delivery" (change)="setDeliveryMethod('Retirar en el taller')" />
        <span class="option-text">
          <strong>Retirar en el taller</strong> - El taller Virrey Olaguer y Feliú 5197, B1605 Munro, Provincia de Buenos Aires
        </span>
      </label>

      <label class="delivery-option">
        <input type="radio" name="delivery" (change)="setDeliveryMethod('Contactar por WhatsApp')" />
        <span class="option-text">
          Quiero que me lo envíen - Contactar a un vendedor para cotizar envío - Whatsapp
        </span>
      </label>
    </div>


    <!-- Mensaje de advertencia -->
    <p *ngIf="showDeliveryWarning" class="warning-message">
      ⚠️ Debes seleccionar un método de entrega antes de continuar.
    </p>


    <h2>Datos del Usuario</h2>
    <form #userForm="ngForm">
      <div class="form-group">
        <label for="dni">DNI o CUIT</label>
        <input
          type="text"
          id="dni"
          placeholder="Ingrese su DNI o CUIT"
          [(ngModel)]="userFormData.dni"
          name="dni"
          required
          pattern="^\d{7,11}$"
          #dni="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="dni.invalid && dni.touched" class="error-message">⚠️ Ingrese un DNI o CUIT válido (7 a 11 dígitos).</p>
      </div>

      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input
          type="text"
          id="nombre"
          placeholder="Ingrese su nombre"
          [(ngModel)]="userFormData.nombre"
          name="nombre"
          required
          pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$"
          #nombre="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="nombre.invalid && nombre.touched" class="error-message">⚠️ Ingrese un nombre válido (solo letras).</p>
      </div>

      <div class="form-group">
        <label for="apellido">Apellido</label>
        <input
          type="text"
          id="apellido"
          placeholder="Ingrese su apellido"
          [(ngModel)]="userFormData.apellido"
          name="apellido"
          required
          pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$"
          #apellido="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="apellido.invalid && apellido.touched" class="error-message">⚠️ Ingrese un apellido válido (solo letras).</p>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="email"
          id="email"
          placeholder="Ingrese su email"
          [(ngModel)]="userFormData.email"
          name="email"
          required
          pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
          #email="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="email.invalid && email.touched" class="error-message">
          ⚠️ Ingrese un email válido.
        </p>
      </div>

      <div class="form-group">
        <label for="telefono">Teléfono</label>
        <input
          type="tel"
          id="telefono"
          placeholder="Ingrese su teléfono"
          [(ngModel)]="userFormData.telefono"
          name="telefono"
          required
          pattern="^\+?\d{10,15}$"
          #telefono="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="telefono.invalid && telefono.touched" class="error-message">⚠️ Ingrese un teléfono válido (10 a 15 dígitos).</p>
      </div>

      <div class="form-group">
        <label for="ciudad">Ciudad</label>
        <input
          type="text"
          id="ciudad"
          placeholder="Ingrese su ciudad"
          [(ngModel)]="userFormData.ciudad"
          name="ciudad"
          required
          pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$"
          #ciudad="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="ciudad.invalid && ciudad.touched" class="error-message">⚠️ Ingrese una ciudad válida (solo letras).</p>
      </div>

      <div class="form-group">
        <label for="provincia">Provincia</label>
        <input
          type="text"
          id="provincia"
          placeholder="Ingrese su provincia"
          [(ngModel)]="userFormData.provincia"
          name="provincia"
          required
          pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$"
          #provincia="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="provincia.invalid && provincia.touched" class="error-message">⚠️ Ingrese una provincia válida (solo letras).</p>
      </div>

      <div class="form-group">
        <label for="codigo-postal">Código Postal</label>
        <input
          type="text"
          id="codigo-postal"
          placeholder="Ingrese su código postal"
          [(ngModel)]="userFormData.codigoPostal"
          name="codigoPostal"
          required
          pattern="^\d{4,8}$"
          #codigoPostal="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="codigoPostal.invalid && codigoPostal.touched" class="error-message">⚠️ Ingrese un código postal válido (4 a 8 dígitos).</p>
      </div>

      <div class="form-group">
        <label for="direccion">Dirección</label>
        <input
          type="text"
          id="direccion"
          placeholder="Ingrese su calle y número"
          [(ngModel)]="userFormData.direccion"
          name="direccion"
          required
          pattern="^[A-Za-zÁÉÍÓÚÑáéíóúñ0-9\s]+$"
          #direccion="ngModel"
          (ngModelChange)="validateForm()"
        />
        <p *ngIf="direccion.invalid && direccion.touched" class="error-message">
          ⚠️ Ingrese una dirección válida (solo letras, números y espacios).
        </p>
      </div>

      <div class="form-group">
        <label for="departamento">Número de Departamento (Opcional)</label>
        <input type="text" id="departamento" placeholder="Ingrese su número de departamento" [(ngModel)]="userFormData.departamento" name="departamento" />
      </div>
    </form>


  </div>

  <div class="product-summary">
    <img
    [src]="'assets/sello1.png'"
    class="producto-seguro"
  />
  <h2>Detalles del Producto</h2>
  <div class="product-details" *ngIf="productData">
    <img
      [src]="productData.imagen || 'assets/default-product.webp'"
      [alt]="productData.nombre || productData.codigoFinal"
      class="product-image"
    />
    <p><strong>Producto:</strong> {{ productData.nombre || productData.codigoFinal }}</p>

    <div class="price-container">
      <p>
        <strong>Precio Original: </strong>
        <span class="original-price">${{ productData.totalAmount | number:'1.0-0' }}</span>
      </p>
      <span class="discount-badge">-14%</span>
    </div>

    <p class="discounted-price"><strong>Total con descuento:</strong> ${{ discountedTotal | number:'1.0-0' }}</p>
  </div>




    <!-- Advertencia si no se ha completado el formulario -->
    <div *ngIf="showWarning" class="warning-message">
      <p>⚠️ Debes completar todos los campos y seleccionar un método de entrega antes de pagar.</p>
    </div>

    <button class="submit-button" [disabled]="!isFormComplete" (click)="attemptPayment(userForm)">
      Pagar
    </button>

    <div *ngIf="isLoading" class="loading-overlay">
      <div class="spinner"></div>
      <p>Estamos creando el pago, por favor espera...</p>
    </div>
  </div>
</div>

<app-footer></app-footer>
