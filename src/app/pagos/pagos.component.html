<app-navbar></app-navbar>

<div class="form-container">
  <div class="user-form">

    <!-- Selección del método de entrega -->
    <h2>Método de Entrega</h2>
    <div class="delivery-method">
      <label>
        <input type="radio" name="delivery" (change)="setDeliveryMethod('Retirar en el taller')" required />
        <strong>Retirar en el taller</strong> - El taller Virrey Olaguer y Feliú 5197, B1605 Munro, Provincia de Buenos Aires
      </label>
      <br />
      <label>
        <input type="radio" name="delivery" (change)="setDeliveryMethod('Contactar por WhatsApp')" required />
        <strong>Contactar por WhatsApp</strong> - Un asesor se pondrá en contacto contigo
      </label>
    </div>

    <h2>Datos del Usuario</h2>
    <form>
      <div class="form-group">
        <label for="dni">DNI o CUIT</label>
        <input type="text" id="dni" placeholder="Ingrese su DNI o CUIT" [(ngModel)]="userForm.dni" (ngModelChange)="validateForm()" name="dni" />
      </div>

      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" placeholder="Ingrese su nombre" [(ngModel)]="userForm.nombre" (ngModelChange)="validateForm()" name="nombre" />
      </div>

      <div class="form-group">
        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" placeholder="Ingrese su apellido" [(ngModel)]="userForm.apellido" (ngModelChange)="validateForm()" name="apellido" />
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="text" id="email" placeholder="Ingrese su email" [(ngModel)]="userForm.email" (ngModelChange)="validateForm()" name="email" />
      </div>

      <div class="form-group">
        <label for="telefono">Teléfono</label>
        <input type="text" id="telefono" placeholder="Ingrese su teléfono" [(ngModel)]="userForm.telefono" (ngModelChange)="validateForm()" name="telefono" />
      </div>

      <div class="form-group">
        <label for="ciudad">Ciudad</label>
        <input type="text" id="ciudad" placeholder="Ingrese su ciudad" [(ngModel)]="userForm.ciudad" (ngModelChange)="validateForm()" name="ciudad" />
      </div>

      <div class="form-group">
        <label for="codigo-postal">Código Postal</label>
        <input type="text" id="codigo-postal" placeholder="Ingrese su código postal" [(ngModel)]="userForm.codigoPostal" (ngModelChange)="validateForm()" name="codigoPostal" />
      </div>

      <div class="form-group">
        <label for="provincia">Provincia</label>
        <input type="text" id="provincia" placeholder="Ingrese su provincia" [(ngModel)]="userForm.provincia" (ngModelChange)="validateForm()" name="provincia" />
      </div>

      <div class="form-group">
        <label for="departamento">Número de Departamento (Opcional)</label>
        <input type="text" id="departamento" placeholder="Ingrese su número de departamento" [(ngModel)]="userForm.departamento" name="departamento" />
      </div>
    </form>

  </div>

  <div class="product-summary">
    <h2>Detalles del Producto</h2>
    <div class="product-details" *ngIf="productData">
      <img
        [src]="productData.imagen || 'assets/default-product.webp'"
        [alt]="productData.nombre || productData.codigoFinal"
        class="product-image"
      />
      <p><strong>Producto:</strong> {{ productData.nombre || productData.codigoFinal }}</p>
      <p><strong>Precio:</strong> ${{ productData.totalAmount }}</p>
      <p *ngIf="discountApplied; else originalTotal"><strong>Total con descuento:</strong> ${{ discountedTotal }}</p>
      <ng-template #originalTotal>
        <p><strong>Total:</strong> ${{ productData.totalAmount }}</p>
      </ng-template>

      <!-- Cupón de Descuento -->
      <div class="discount-section">
        <label for="discount-code"><strong>¿Tienes un cupón de descuento?</strong></label>
        <input type="text" id="discount-code" [(ngModel)]="discountCode" placeholder="Ingrese su código" />
        <button class="payment-toggle-button" (click)="applyDiscount()">Aplicar Cupón</button>
        <p *ngIf="invalidCoupon" class="error-message">⚠️ Cupón inválido o expirado.</p>
      </div>
    </div>

    <!-- Advertencia si no se ha completado el formulario -->
    <div *ngIf="showWarning" class="warning-message">
      <p>⚠️ Debes completar todos los campos y seleccionar un método de entrega antes de pagar.</p>
    </div>

    <button class="submit-button" [disabled]="!isFormComplete" (click)="attemptPayment()">
      Pagar
    </button>


    <div *ngIf="isLoading" class="loading-overlay">
      <div class="spinner"></div>
      <p>Estamos creando el pago, por favor espera...</p>
    </div>
  </div>
</div>

<app-footer></app-footer>
